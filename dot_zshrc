# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi


# If you come from bash you might have to change your $PATH.
# export PATH=$HOME/bin:$HOME/.local/bin:/usr/local/bin:$PATH

# Path to your Oh My Zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Set name of the theme to load --- if set to "random", it will
# load a random theme each time Oh My Zsh is loaded, in which case,
# to know which specific one was loaded, run: echo $RANDOM_THEME
# See https://github.com/ohmyzsh/ohmyzsh/wiki/Themes
ZSH_THEME="powerlevel10k/powerlevel10k"

# Uncomment the following line to use case-sensitive completion.
# CASE_SENSITIVE="true"

# Uncomment the following line to use hyphen-insensitive completion.
# Case-sensitive completion must be off. _ and - will be interchangeable.
# HYPHEN_INSENSITIVE="true"

# Uncomment one of the following lines to change the auto-update behavior
# zstyle ':omz:update' mode disabled  # disable automatic updates
# zstyle ':omz:update' mode auto      # update automatically without asking
# zstyle ':omz:update' mode reminder  # just remind me to update when it's time

# Uncomment the following line to change how often to auto-update (in days).
# zstyle ':omz:update' frequency 13

# Uncomment the following line if pasting URLs and other text is messed up.
# DISABLE_MAGIC_FUNCTIONS="true"

# Uncomment the following line to disable colors in ls.
# DISABLE_LS_COLORS="true"

# Uncomment the following line to disable auto-setting terminal title.
# DISABLE_AUTO_TITLE="true"

# Uncomment the following line to enable command auto-correction.
# ENABLE_CORRECTION="true"

# Uncomment the following line to display red dots whilst waiting for completion.
# You can also set it to another string to have that shown instead of the default red dots.
# e.g. COMPLETION_WAITING_DOTS="%F{yellow}waiting...%f"
# Caution: this setting can cause issues with multiline prompts in zsh < 5.7.1 (see #5765)
# COMPLETION_WAITING_DOTS="true"

# Uncomment the following line if you want to disable marking untracked files
# under VCS as dirty. This makes repository status check for large repositories
# much, much faster.
# DISABLE_UNTRACKED_FILES_DIRTY="true"

# Uncomment the following line if you want to change the command execution time
# stamp shown in the history command output.
# You can set one of the optional three formats:
# "mm/dd/yyyy"|"dd.mm.yyyy"|"yyyy-mm-dd"
# or set a custom format using the strftime function format specifications,
# see 'man strftime' for details.
# HIST_STAMPS="mm/dd/yyyy"

# Which plugins would you like to load?
# Standard plugins can be found in $ZSH/plugins/
# Custom plugins may be added to $ZSH_CUSTOM/plugins/
# Add wisely, as too many plugins slow down shell startup.
plugins=(git zsh-autosuggestions zsh-claude-code-shell zsh-history-substring-search)

source $ZSH/oh-my-zsh.sh

# User configuration

# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='nvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch $(uname -m)"

# Set personal aliases, overriding those provided by Oh My Zsh libs,
# plugins, and themes. Aliases can be placed here, though Oh My Zsh
# users are encouraged to define aliases within a top-level file in
# the $ZSH_CUSTOM folder, with .zsh extension. Examples:
# - $ZSH_CUSTOM/aliases.zsh
# - $ZSH_CUSTOM/macos.zsh
# For a full list of active aliases, run `alias`.
#
# Example aliases
# alias zshconfig="mate ~/.zshrc"
# alias ohmyzsh="mate ~/.oh-my-zsh"

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# bun completions
[ -s "/home/chong/.bun/_bun" ] && source "/home/chong/.bun/_bun"

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
export PATH=$PATH:~/miniconda3/bin
export PATH=$PATH:/opt/homebrew/bin
# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/home/chong/miniconda3/bin/conda' 'shell.zsh' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/home/chong/miniconda3/etc/profile.d/conda.sh" ]; then
        . "/home/chong/miniconda3/etc/profile.d/conda.sh"
    else
        export PATH="/home/chong/miniconda3/bin:$PATH"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<

# >>> CBA zshrc >>>
[ -f ~/.cba_zshrc.sh ] && source ~/.cba_zshrc.sh
# <<< CBA zshrc <<<

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
alias ai="NODE_NO_WARNINGS=1 ai"
    
# --- Modern Tool Aliases ---
alias ls="eza --icons --group-directories-first"
alias ll="eza -l --icons --git --group-directories-first"
command -v fdfind >/dev/null && alias fd=fdfind || alias fdfind=fd

alias du="dust"
alias cc="claude"
# alias micro="micro +9999999"
# alias nano="micro +9999999"
# alias zell="zellij"
[ -f ~/.zellig_rc.sh ] && source ~/.zellig_rc.sh


if command -v batcat &>/dev/null; then
  BAT=batcat
else
  BAT=bat
fi

export PAGER="$BAT"
alias cat="$BAT --plain --tabs 0 --number --style=grid"


# Interactive search through file contents
fzr() {
  rg --column --line-number --no-heading --color=always --smart-case -- "${*:-}" |
    fzf --ansi \
        --delimiter : \
        --preview 'sh -c "$BAT --color=always {1} --highlight-line {2}"' \
        --preview-window 'up,60%,border-bottom,+{2}+3/3,~3'
}



if command -v fd >/dev/null; then
  	#export FZF_DEFAULT_COMMAND='fd --strip-cwd-prefix --hidden --follow --exclude .git'
  	export FZF_DEFAULT_COMMAND="fd --type f --hidden --follow --exclude .git"
else
  	#export FZF_DEFAULT_COMMAND='fdfind --strip-cwd-prefix --hidden --follow --exclude .git'
  	export FZF_DEFAULT_COMMAND="fdfind --type f --hidden --follow --exclude .git"
fi

fz() {
  if command -v batcat &>/dev/null; then
    fzf --preview '[[ -d {} ]] && eza --tree --color=always {} | head -200 || batcat --color=always --style=numbers --line-range=:500 {}'
  else
    fzf --preview '[[ -d {} ]] && eza --tree --color=always {} | head -200 || bat --color=always --style=numbers --line-range=:500 {}'
  fi
}

# ctrl+p widget
fzf-file-widget() {
  local sel quoted

  sel=$(eval "$FZF_DEFAULT_COMMAND" | fz --multi) || { zle reset-prompt; return }

  quoted=()
  for f in ${(f)sel}; do
    quoted+=("${(q)f}")
  done

  LBUFFER+="${(j: :)quoted} "
  zle reset-prompt
}
zle -N fzf-file-widget
bindkey '^P' fzf-file-widget

fzr-widget() {
  local line file lineno out

  line=$(fzr) || { zle reset-prompt; return }

  file=${line%%:*}
  lineno=${line#*:}; lineno=${lineno%%:*}

  # doesn't work
  #out="${file}:${lineno}"
  #LBUFFER+="${(q)out} "

  cmd=(micro +$lineno "$file")
  LBUFFER+="micro +${lineno} ${(q)file} "
  
  zle reset-prompt
}

zle -N fzr-widget
KEYTIMEOUT=10
bindkey '^[[102;6u' fzr-widget   # your Ctrl+Shift+F



zse() {
    local checksum_before=$(md5sum ~/.zshrc | cut -d' ' -f1)
    micro +9999999 ~/.zshrc
    local checksum_after=$(md5sum ~/.zshrc | cut -d' ' -f1)

    if [[ "$checksum_before" == "$checksum_after" ]]; then
        echo "‚ÑπÔ∏è  No changes made to .zshrc."
        return
    fi

    if zsh -n ~/.zshrc; then
        # if command -v chezmoi &> /dev/null; then
        #     chezmoi apply ~/.zshrc
        # fi
        source ~/.zshrc
        echo "üöÄ Updated and sourced .zshrc."
    else
        echo "‚ùå Syntax error detected in .zshrc! Not sourcing."
    fi
}
alias zss="source ~/.zshrc && echo '‚úÖ sourced .zshrc.'"
alias zsr="exec $SHELL -l"

function zj() {
    # Lists sessions and lets you pick one to attach, or starts a new one
    zellij attach $(zellij list-sessions | fzf) || zellij
}

eval "$(zoxide init zsh)"

# --- Editor Settings ---
export EDITOR='micro'
export VISUAL='micro'

# --- Init Tools ---
# source <(fzf --zsh)

source ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
export PATH="$PATH:/snap/bin"

bindkey '^[[H' beginning-of-line
bindkey '^[[F' end-of-line

# --- Yazi Wrapper ---
# This makes it so when you quit yazi, your shell stays in the directory you were in.
function yz() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
	yazi "$@" --cwd-file="$tmp"
	if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		builtin cd -- "$cwd"
	fi
	rm -f -- "$tmp"
}

chz() {
	if [[ "$1" == "link" && -n "$2" ]]; then
		local target_file=$(realpath "$2")
        local filename=$(basename "$target_file")

        # Determine local name
        local clean_name
        [[ "$filename" == .* ]] && clean_name="$filename" || clean_name=".$filename"

        local link_dir="$HOME/.config/ext-links"
        mkdir -p "$link_dir"
        local link_path="$link_dir/$clean_name"

        # Create the symlink locally
        echo "üîó Linking $target_file to $link_path..."
        ln -sf "$target_file" "$link_path"

        # IMPORTANT: Add with --follow to track CONTENT, not the link
        command chezmoi add --follow "$link_path"
        echo "‚úÖ Content tracked! Use 'chz addp' to push."
	elif [[ "$1" == "addp" ]]; then
        shift # Remove 'addp'

        if [[ $# -gt 0 ]]; then
            # Arguments exist: track the file first
            echo "üì¶ Tracking new files..."
            command chezmoi add --follow "$@"
            local msg="feat: update $filename ($*)"
        else
            # No arguments: just sync existing changes
            echo "üöÄ No files specified. Syncing existing changes..."
            local msg="chore: bulk sync dotfiles $(date +'%Y-%m-%d %H:%M')"
        fi

        # Git sequence
        command chezmoi git add .
        command chezmoi git commit -- -m "$msg"
        command chezmoi git push

        echo "‚úÖ Changes committed and pushed!"
    elif [[ "$1" == "add" && -n "$2" ]]; then
        shift
    	echo "NB: to add, commit and push, use \"cz addp\" with a p."
    	chezmoi add "$@"
    	chezmoi git add .
    elif [[ "$1" == "git" ]]; then
        # This allows you to run 'chz git remote set-url ...' or any git command
        shift
        command chezmoi git -- "$@"
    elif [[ "$1" == "cd" ]]; then
    	command cd ~/.local/share/chezmoi
    elif [[ "$1" == "commit-main" ]]; then
    	local CHEZMOI_BRANCH="$(chezmoi git --  branch --show-current)"
    	chezmoi re-add || return 1 # must re-add before checking out, otherwise will include all the changes made by the current branch
    	chezmoi git -- checkout main || {
    		echo "Checkout to main failed (likely uncommitted changes)."
    	    return 1
    	}
    	chezmoi git -- add -u || return 1
    	chezmoi git -- commit -m"updated existing files" || true
    	chezmoi git -- checkout $CHEZMOI_BRANCH || return 1
    	chezmoi git -- rebase main || return 1
    else
        # Pass all other commands (status, apply, edit, etc.) through to chezmoi
        case "$1" in
            commit|push)
                # Route these specifically to 'chezmoi git'
                command chezmoi git -- "$@"
                ;;
            *)
                # All other commands go to standard 'chezmoi'
                command chezmoi "$@"
                ;;
        esac
    fi
}

alias ve="source .venv/bin/activate"

[[ -f "$HOME/.local/bin/env" ]] && . "$HOME/.local/bin/env"
[[ -x "$HOME/.atuin/bin/atuin" ]] && export PATH="$HOME/.atuin/bin:$PATH"
eval "$(atuin init zsh --disable-up-arrow)"

# Disable sharing history between sessions
unsetopt share_history
unsetopt inc_append_history
unsetopt inc_append_history_time

# Ensure history is only appended when the session exits
setopt append_history

# Kill process on a specific port
killon() {
  if [ -z "$1" ]; then
    echo "Please provide a port number (e.g., killon 1420)"
  else
    echo "Killing process on port $1..."
    lsof -ti :$1 | xargs kill -9
  fi
}
